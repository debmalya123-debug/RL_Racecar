<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RL based Racecar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <h1 style="margin-bottom: 20px;">Reinforcement Learning Racecar</h1>
        
        <!-- Caution -->
        <div class="caution-card">
            <strong>‚ö†Ô∏è Note:</strong> 
            Proper driving behavior typically emerges around Generation 150. Initial generations will crash often as they explore. Please be Patient !!
        </div>

        <!-- Main Layout: Canvas + Dashboard -->
        <div class="main-layout">
            
            <!-- Top: Simulation -->
            <div class="canvas-container">
                <!-- HUD -->
                <div class="hud width-constraint" style="position: relative; top: 0; margin-bottom: 15px;">
                    <div class="stat-group">
                        <div class="stat-badge">Gen: <span id="gen-count">1</span></div>
                        <div class="stat-badge">Alive: <span id="alive-count">0</span></div>
                    </div>
                    
                    <div class="controls">
                        <button id="restartBtn" class="restart-btn" title="Hard Reset">‚Ü∫</button>
                        <button id="pauseBtn" class="pause-btn" title="Play/Pause">‚è∏</button>
                        <label for="speedRange" style="margin-right: 5px;">Speed:</label>
                        <span id="speedVal" style="width: 30px; display:inline-block; font-weight:bold;">1x</span>
                        <input type="range" id="speedRange" min="1" max="50" value="1">
                    </div>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="raceCanvas" width="800" height="600"></canvas>
                    <div class="scanlines"></div>
                </div>
            </div>

            <!-- Bottom: Analytics Dashboard -->
            <div class="dashboard width-constraint">
                
                <!-- 1. Log Table -->
                <div class="log-panel">
                    <div class="log-header">
                        <span>Performance Log</span>
                        <span style="font-size: 11px; color: #636e72;">Scrollable ‚¨á</span>
                    </div>
                    <div class="log-table-wrapper">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Gen</th>
                                    <th>Best Dist</th>
                                    <th>Epsilon</th>
                                </tr>
                            </thead>
                            <tbody id="logBody">
                                <!-- Rows added by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Chart -->
                <div class="chart-panel">
                    <div class="log-header">
                        <span>Learning Progress</span>
                    </div>
                    <div style="flex:1; padding:10px; position:relative;">
                        <canvas id="perfChart"></canvas>
                    </div>
                </div>

            </div>

        </div>

    </div>
    
    <div class="info-section">
        <!-- Card 1: Theory -->
        <div class="card">
            <h2>RL Theory: SARSA</h2>
            <p><strong>SARSA: State-Action-Reward-State-Action</strong></p>
            <p>The car is an agent that learns through <strong>Trial & Error</strong>. It doesn't know physics strategies. It only knows:</p>
            <div class="flow-diagram">
                <div class="node">üëÄ See<br><span>(LIDAR)</span></div>
                <div class="arrow">‚û°</div>
                <div class="node">üß† Think<br><span>(Q-Table)</span></div>
                <div class="arrow">‚û°</div>
                <div class="node">üèéÔ∏è Act<br><span>(Steer)</span></div>
            </div>
            <p style="margin-top:15px; font-size:13px;">
                If it crashes, it receives a <strong>Negative Reward</strong> and updates its memory to avoid that action in the future.
            </p>
        </div>

        <!-- Card 2: Valid Visual -->
        <div class="card">
            <h2>The Update Equation</h2>
            <div class="equation">
                Q(S,A) <span class="eq-op">+=</span> Œ± * (<span class="highlight">R</span> + Œ≥Q' - Q)
            </div>
            <ul class="legend">
                <li><span class="dot red"></span> <strong>R (Reward):</strong> Feedback (+Speed, -Crash)</li>
                <li><span class="dot blue"></span> <strong>Q(S,A):</span> Expected Value of Action</li>
                <li><span class="dot green"></span> <strong>Œ± (Alpha):</strong> Learning Rate</li>
            </ul>
            <p style="margin-top:10px; font-size:12px; color:#b2bec3; font-style:italic;">
                *Over generations, the Q-values converge to the optimal driving strategy.*
            </p>
        </div>

        <!-- Card 3: Evolution -->
        <div class="card">
            <h2>Genetic Evolution</h2>
            <p><strong>Method: Survival of the Fittest</strong></p>
            <p>At the end of each generation, the <strong>Best Performing Cars</strong> are selected as parents.</p>
            
            <div class="flow-diagram">
                 <div class="node">üèÜ Best<br><span>(Parent)</span></div>
                 <div class="arrow">‚û°</div>
                 <div class="node">üß¨ Mutate<br><span>(Change)</span></div>
                 <div class="arrow">‚û°</div>
                 <div class="node">üê£ Child<br><span>(Next Gen)</span></div>
            </div>

            <p style="margin-top:15px; font-size:13px;">
                We add random <strong>Mutations</strong> to exploration rates and Q-values to discover better paths.
            </p>
        </div>
    </div>

    <div class="footer">
        Made with ‚ù§Ô∏è by <strong>Debmalya Paul</strong> | 
        <a href="https://github.com/debmalya123-debug" target="_blank">GitHub @debmalya123-debug</a>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
